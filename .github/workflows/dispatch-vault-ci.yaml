# Use like:

# name: Dispatch Vault CI On Branch
# on:
#   workflow_dispatch:
# jobs:
#   dispatch:
#     # using `main` as the ref will keep your workflow up-to-date
#     uses: hashicorp/vault-workflows-common/.github/workflows/dispatch-vault-ci.yaml@main
#     secrets:
#       VAULT_ECO_GITHUB_TOKEN: ${{ secrets.VAULT_ECO_GITHUB_TOKEN }}
#     with:
#       repository: ${{ github.repository }}
#       branch: my-branch

name: Dispatch Vault CI On Branch

on:
  workflow_call:
    inputs:
      repository:
        required: true
        type: string
        description: 'The owner and repository name as per the github.repository context property.'
      branch:
        required: true
        type: string
        description: 'The name of the plugin branch'
    secrets:
      VAULT_ECO_GITHUB_TOKEN:
        required: true
        description: 'Should be different than the default GITHUB_TOKEN so that this workflow will trigger checks on the resulting PR.'

jobs:
  dispatch:
    name: Dispatch Vault CI
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.VAULT_ECO_GITHUB_TOKEN }}
    steps:
      - name: Dispatch Vault Plugin Update Check
        run: |
          curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{secrets.VAULT_ECO_GITHUB_TOKEN}}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/hashicorp/vault/actions/workflows/plugin-update-check.yml/dispatches \
          -d '{"ref":"main","inputs":{"repo":"${{inputs.repository}}","plugin_branch":"${{inputs.branch}}"}}'

